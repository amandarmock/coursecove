generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Enums (Type Safety)
// ============================================

enum MembershipRole {
  SUPER_ADMIN
  INSTRUCTOR
  STUDENT
  GUARDIAN
}

enum MembershipStatus {
  ACTIVE
  SUSPENDED
  DELETED
  REMOVED // Soft-deleted, restorable for 30 days
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// Core Tables
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  subdomain String?  @unique // For *.coursecove.com routing
  email     String?
  phone     String?

  // Clerk integration
  clerkOrganizationId String? @unique @map("clerk_organization_id")

  // Status
  status    MembershipStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  memberships            OrganizationMembership[]
  invitations            Invitation[]
  rolePermissions        RolePermission[]        // F001: Custom permissions per organization
  appointmentTypes           AppointmentType[]           // F001: Appointment types offered
  appointments        Appointment[]        // F001: Appointments
  appointmentTypeInstructors AppointmentTypeInstructor[] // F001: Junction table
  businessLocations      BusinessLocation[]      // F001: Business location addresses
  instructorAvailability InstructorAvailability[] // F002: Instructor availability records

  // Indexes
  @@index([subdomain])
  @@index([status])
  @@index([clerkOrganizationId])
  @@map("organizations")
}

model User {
  id        String   @id @default(cuid())

  // Clerk integration
  clerkUserId String @unique @map("clerk_user_id")

  // Profile
  email     String   @unique
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  avatarUrl String?  @map("avatar_url")
  timezone  String   @default("America/New_York") // F002: IANA timezone identifier

  // Status
  status    MembershipStatus @default(ACTIVE)

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  memberships             OrganizationMembership[]
  invitationsSent         Invitation[]             @relation("InvitedBy")
  invitationsAccepted     Invitation[]             @relation("AcceptedBy")

  // Indexes
  @@index([clerkUserId])
  @@index([email])
  @@index([status])
  @@map("users")
}

model OrganizationMembership {
  id        String   @id @default(cuid())

  // Foreign keys
  organizationId String @map("organization_id")
  userId         String @map("user_id")

  // Role (scoped per organization) - ENUM for type safety
  role MembershipRole

  // Clerk integration
  clerkMembershipId String? @unique @map("clerk_membership_id")

  // Status
  status MembershipStatus @default(ACTIVE)

  // Soft delete tracking (for REMOVED status)
  removedAt DateTime? @map("removed_at") // When soft-deleted
  removedBy String?   @map("removed_by") // Who initiated removal (user ID or "clerk_webhook")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // F001: Appointment relations (as participant/creator)
  studentAppointments      Appointment[]        @relation("StudentAppointments")
  instructorAppointments   Appointment[]        @relation("InstructorAppointments")
  createdAppointments      Appointment[]        @relation("CreatedAppointments")
  qualifiedAppointmentTypes AppointmentTypeInstructor[] @relation("QualifiedInstructors")

  // F002: Instructor availability (per-org schedules)
  availability             InstructorAvailability[]

  // Constraints
  @@unique([organizationId, userId])
  @@index([userId])
  @@index([organizationId])
  @@index([role])
  @@index([clerkMembershipId])
  @@map("organization_memberships")
}

model Invitation {
  id        String   @id @default(cuid())

  // Foreign keys
  organizationId String @map("organization_id")
  invitedById    String @map("invited_by")
  acceptedById   String? @map("accepted_by")

  // Invitation details
  email  String
  role   MembershipRole // Use enum for consistency
  token  String  @unique

  // Status - use enum for type safety
  status InvitationStatus @default(PENDING)

  // Timestamps
  expiresAt  DateTime  @map("expires_at")
  acceptedAt DateTime? @map("accepted_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("InvitedBy", fields: [invitedById], references: [id])
  acceptedBy   User?        @relation("AcceptedBy", fields: [acceptedById], references: [id])

  // Indexes
  @@index([email])
  @@index([organizationId])
  @@index([token])
  @@index([status])
  @@index([expiresAt]) // For cleanup queries
  @@map("invitations")
}

model WebhookEvent {
  id          String    @id @default(cuid())

  // Clerk webhook identifier (for idempotency)
  webhookId   String    @unique @map("webhook_id") // svix-id from headers

  // Event details
  eventType   String    @map("event_type")  // e.g., "user.created"
  payload     Json                          // Full webhook payload

  // Processing status
  status      String    @default("pending") // pending, completed, failed
  attempts    Int       @default(0)         // Number of processing attempts

  // Error tracking
  lastError   String?   @map("last_error")  // Last error message if failed

  // Timestamps
  processedAt DateTime? @map("processed_at") // When successfully processed
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")  // Soft delete support

  // Indexes for efficient queries
  @@index([eventType])
  @@index([status])
  @@index([createdAt])
  @@map("webhook_events")
}

// ============================================
// F001: Permission System
// ============================================

model Permission {
  id          String   @id @default(cuid())

  // Permission details
  resource    String   // e.g., "appointment_types", "appointments"
  action      String   // e.g., "create", "edit", "delete", "publish"
  description String   // Human-readable description

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  rolePermissions RolePermission[]

  // Constraints
  @@unique([resource, action])
  @@index([resource])
  @@map("permissions")
}

model RolePermission {
  id             String         @id @default(cuid())

  // Foreign keys
  role           MembershipRole
  permissionId   String         @map("permission_id")
  organizationId String         @map("organization_id")

  // Timestamps
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")

  // Relations
  permission     Permission     @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Constraints - one permission per role per organization
  @@unique([role, permissionId, organizationId])
  @@index([role])
  @@index([organizationId])
  @@map("role_permissions")
}

// ============================================
// F001: Appointment Management
// ============================================

enum AppointmentTypeStatus {
  DRAFT
  PUBLISHED
  UNPUBLISHED
}

enum AppointmentTypeCategory {
  PRIVATE_LESSON
  APPOINTMENT
}

enum AppointmentStatus {
  UNBOOKED
  BOOKED
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum LocationMode {
  BUSINESS_LOCATION
  ONLINE
  STUDENT_LOCATION
}

model BusinessLocation {
  id             String   @id @default(cuid())

  // Foreign keys
  organizationId String   @map("organization_id")

  // Location details
  name           String   // e.g., "Studio A", "Downtown Branch"
  address        String
  city           String
  state          String
  zipCode        String   @map("zip_code")
  notes          String?  @db.Text // e.g., "Enter through side door", "Free parking in rear"

  // Status
  isActive       Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  deletedAt      DateTime? @map("deleted_at") // Soft delete

  // Relations
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  appointmentTypes AppointmentType[]

  // Indexes
  @@index([organizationId])
  @@index([isActive])
  @@index([deletedAt])
  @@index([organizationId, isActive, deletedAt]) // Compound index for common queries
  @@map("business_locations")
}

model AppointmentType {
  id          String            @id @default(cuid())

  // Foreign keys
  organizationId String         @map("organization_id")

  // Appointment type details
  name        String
  description String?           @db.Text
  duration    Int               // Duration in minutes
  status      AppointmentTypeStatus @default(DRAFT)
  category    AppointmentTypeCategory @default(APPOINTMENT)

  // Location settings
  locationMode      LocationMode     @default(BUSINESS_LOCATION) @map("location_mode")
  businessLocationId String?         @map("business_location_id") // If locationMode is BUSINESS_LOCATION

  // Optimistic locking
  version     Int               @default(0)

  // Timestamps
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")
  deletedAt   DateTime?         @map("deleted_at") // Soft delete

  // Relations
  organization       Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessLocation   BusinessLocation?         @relation(fields: [businessLocationId], references: [id])
  appointments    Appointment[]
  instructors        AppointmentTypeInstructor[]

  // Indexes
  @@index([organizationId])
  @@index([status])
  @@index([deletedAt])
  @@index([businessLocationId])
  @@index([organizationId, status, deletedAt]) // Compound index for common queries
  @@index([organizationId, category, deletedAt]) // Compound index for category filtering
  @@map("appointment_types")
}

model Appointment {
  id             String        @id @default(cuid())

  // Foreign keys
  appointmentTypeId  String?       @map("appointment_type_id") // Nullable for ad-hoc appointments
  organizationId String        @map("organization_id")

  // Participants (OrganizationMembership IDs)
  studentId      String        @map("student_id")
  instructorId   String        @map("instructor_id")
  createdBy      String        @map("created_by")

  // Appointment details (can override appointment type)
  title          String
  description    String?       @db.Text
  duration       Int           // Duration in minutes
  status         AppointmentStatus @default(UNBOOKED)

  // Location
  isOnline        Boolean      @map("is_online")
  videoLink       String?      @map("video_link")
  locationAddress String?      @map("location_address")

  // Notes
  notes          String?       @db.Text

  // Optimistic locking
  version        Int           @default(0)

  // Timestamps
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")
  deletedAt      DateTime?     @map("deleted_at") // Soft delete

  // Relations
  appointmentType  AppointmentType?           @relation(fields: [appointmentTypeId], references: [id], onDelete: Restrict)
  student      OrganizationMembership @relation("StudentAppointments", fields: [studentId], references: [id], onDelete: Restrict)
  instructor   OrganizationMembership @relation("InstructorAppointments", fields: [instructorId], references: [id], onDelete: Restrict)
  creator      OrganizationMembership @relation("CreatedAppointments", fields: [createdBy], references: [id], onDelete: Restrict)
  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([appointmentTypeId])
  @@index([studentId])
  @@index([instructorId])
  @@index([createdBy])
  @@index([organizationId])
  @@index([status])
  @@index([deletedAt])
  @@map("appointments")
}

model AppointmentTypeInstructor {
  id             String                 @id @default(cuid())

  // Foreign keys
  appointmentTypeId  String                 @map("appointment_type_id")
  instructorId   String                 @map("instructor_id") // OrganizationMembership ID
  organizationId String                 @map("organization_id") // For RLS policies

  // Timestamps
  createdAt      DateTime               @default(now()) @map("created_at")

  // Relations
  appointmentType    AppointmentType            @relation(fields: [appointmentTypeId], references: [id], onDelete: Cascade)
  instructor     OrganizationMembership @relation("QualifiedInstructors", fields: [instructorId], references: [id], onDelete: Cascade)
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Constraints - prevent duplicate assignments
  @@unique([appointmentTypeId, instructorId])
  @@index([appointmentTypeId])
  @@index([instructorId])
  @@index([organizationId])
  @@map("appointment_type_instructors")
}

// ============================================
// F002: Instructor Availability
// ============================================

model InstructorAvailability {
  id             String   @id @default(cuid())

  // Foreign keys
  instructorId   String   @map("instructor_id")  // OrganizationMembership ID
  organizationId String   @map("organization_id")

  // Availability details
  dayOfWeek      Int      // 0=Sunday, 6=Saturday (JS convention)
  startTime      DateTime @db.Time @map("start_time") // Wall-clock time (no timezone)
  endTime        DateTime @db.Time @map("end_time")   // Wall-clock time (no timezone)

  // Timestamps
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  instructor     OrganizationMembership @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([instructorId])
  @@index([organizationId])
  @@index([instructorId, dayOfWeek])
  @@map("instructor_availability")
}